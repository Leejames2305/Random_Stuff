#include P18F4520.INC

    CONFIG OSC = INTIO67 ; Internal oscillator, I/O function on RA6/OSC2/CLKO, RA7/OSC1/CLKI
    
    CONFIG WDT=OFF
    CONFIG LVP=OFF
    CONFIG PBADEN=OFF
    LIST P=18F4520
    LIST F=INHX8M


	ORG 0x00
	GOTO MAIN
	
MAIN	
	MOVLW 0x30
	MOVWF OSCCON
	CALL INIT_ADC
	CALL INIT_PWM
	
MAIN_LOOP  
	CALL READ_ADC
	CALL SET_PWM_DUTY
	GOTO MAIN_LOOP
	
INIT_ADC
	MOVLW 0x00
	MOVWF ADCON1
	MOVLW 0x81
	MOVWF ADCON0
	RETURN
	
READ_ADC
	BSF ADCON0, GO
WAIT_ADC
	BTFSC ADCON0, GO
	GOTO WAIT_ADC
	MOVF ADRESH, W
	RETURN
	
INIT_PWM
	CLRF PORTC  ;Clear data latches at port C bit 2 (ccp1)
	BCF TRISC, 2
	
	MOVLW 0x0C
	MOVWF CCP1CON
	MOVLW 0x9C
	MOVWF PR2
	MOVLW 0x07
	MOVWF T2CON
	
	BCF PIR1, TMR2IF
	BSF T2CON, TMR2ON
	
	RETURN
	
SET_PWM_DUTY
	MOVWF CCPR1L
	RETURN
	
	END